# Deployment Guide: Syntiant Atlas

This guide covers deploying your application with:
- **Frontend (Next.js)** → Vercel
- **Backend (NestJS API)** → Railway
- **Database (PostgreSQL)** → Railway
- **Redis** → Railway

## Table of Contents
1. [Prerequisites](#prerequisites)
2. [Backend Deployment (Railway)](#backend-deployment-railway)
3. [Frontend Deployment (Vercel)](#frontend-deployment-vercel)
4. [Post-Deployment Steps](#post-deployment-steps)
5. [Troubleshooting](#troubleshooting)

---

## Prerequisites

### Required Accounts
- GitHub account with your repository pushed
- Railway account (https://railway.app)
- Vercel account (https://vercel.com)

### Prepare Your Repository
Ensure your code is pushed to GitHub:
```bash
git add .
git commit -m "Prepare for deployment"
git push origin main
```

---

## Backend Deployment (Railway)

### Step 1: Create Railway Project

1. Go to https://railway.app and sign in
2. Click **"New Project"**
3. Select **"Deploy from GitHub repo"**
4. Authorize Railway to access your GitHub account
5. Select your `syntiantatlas2` repository

### Step 2: Add PostgreSQL Database

1. In your Railway project, click **"+ New"**
2. Select **"Database"** → **"PostgreSQL"**
3. Railway will provision a PostgreSQL instance
4. Note: Railway automatically creates a `DATABASE_URL` variable

### Step 3: Add Redis

1. Click **"+ New"** again
2. Select **"Database"** → **"Redis"**
3. Railway will provision a Redis instance
4. Note: Railway automatically creates a `REDIS_URL` variable

### Step 4: Configure Backend Service

1. Click on your GitHub repo service (it should already be added)
2. Go to **"Settings"** → **"General"**
3. Configure the following:

   **Root Directory:**
   ```
   apps/api
   ```

   **Build Command:**
   ```bash
   npm install && cd ../.. && npm run db:generate && cd apps/api && npm run build
   ```

   **Start Command:**
   ```bash
   npm run start:prod
   ```

   **Watch Paths:**
   ```
   apps/api/**
   packages/**
   prisma/**
   ```

### Step 5: Environment Variables

Go to **"Variables"** tab and add:

```env
# Node Environment
NODE_ENV=production

# Database (Auto-generated by Railway PostgreSQL)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# Redis (Auto-generated by Railway Redis)
REDIS_URL=${{Redis.REDIS_URL}}

# JWT Secrets (Generate strong random strings)
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_EXPIRY=7d
JWT_REFRESH_SECRET=your-different-refresh-secret-change-this
JWT_REFRESH_EXPIRY=30d

# Admin Credentials
ADMIN_EMAIL=admin@syntiantatlas.com
ADMIN_PASSWORD=Admin@123456

# Application
API_PORT=8080

# CORS (Update after Vercel deployment)
ALLOWED_ORIGINS=https://your-frontend.vercel.app

# Optional: Add when ready
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
STRIPE_SECRET_KEY=your-stripe-secret
STRIPE_WEBHOOK_SECRET=your-stripe-webhook-secret
SENDGRID_API_KEY=your-sendgrid-key
SENDGRID_FROM_EMAIL=noreply@syntiantatlas.com
```

### Step 6: Run Database Migrations

1. Go to your Railway project
2. Click on your API service
3. Go to **"Settings"** → **"Deploy"**
4. After first deployment, open the service URL
5. Or run migrations manually in Railway's terminal:
   ```bash
   npx prisma migrate deploy
   npx prisma db seed
   ```

### Step 7: Get Your Backend URL

1. Go to **"Settings"** → **"Networking"**
2. Click **"Generate Domain"**
3. Copy your backend URL (e.g., `https://your-api.railway.app`)
4. Save this for frontend configuration

---

## Frontend Deployment (Vercel)

### Step 1: Import Project to Vercel

1. Go to https://vercel.com and sign in
2. Click **"Add New"** → **"Project"**
3. Import your `syntiantatlas2` repository from GitHub
4. Vercel will detect it's a monorepo

### Step 2: Configure Build Settings

**Framework Preset:** Next.js

**Root Directory:**
```
apps/web
```

**Build Command:**
```bash
cd ../.. && npm install && npm run build --filter=@syntiant/web
```

**Output Directory:**
```
.next
```

**Install Command:**
```bash
npm install
```

### Step 3: Environment Variables

Add these environment variables in Vercel:

```env
# API Connection
NEXT_PUBLIC_API_URL=https://your-api.railway.app/api

# Node Environment
NODE_ENV=production

# Optional: Analytics, Auth, etc.
NEXT_PUBLIC_GOOGLE_CLIENT_ID=your-google-client-id
```

### Step 4: Deploy

1. Click **"Deploy"**
2. Vercel will build and deploy your frontend
3. You'll get a production URL (e.g., `https://your-app.vercel.app`)

### Step 5: Update Backend CORS

1. Go back to Railway
2. Update the `ALLOWED_ORIGINS` variable:
   ```
   ALLOWED_ORIGINS=https://your-app.vercel.app,https://your-app-*.vercel.app
   ```
3. This allows preview deployments to work too

---

## Post-Deployment Steps

### 1. Test the Deployment

Test your API:
```bash
curl https://your-api.railway.app/api/health
```

Test your frontend:
```
https://your-app.vercel.app
```

### 2. Set up Custom Domains (Optional)

**For Backend (Railway):**
1. Go to Railway project → API service → Settings → Networking
2. Click "Custom Domain"
3. Add your domain (e.g., `api.yourdomain.com`)
4. Configure DNS as instructed

**For Frontend (Vercel):**
1. Go to Vercel project → Settings → Domains
2. Add your domain (e.g., `yourdomain.com`)
3. Configure DNS as instructed

### 3. Configure Production Secrets

Replace all placeholder values with production credentials:
- Generate strong JWT secrets (use `openssl rand -base64 32`)
- Set up Stripe, SendGrid, Twilio accounts
- Configure AWS S3 for file uploads
- Set up Google OAuth

### 4. Monitor Your Application

**Railway:**
- View logs in Railway dashboard
- Set up metrics and alerts
- Monitor database performance

**Vercel:**
- View deployment logs
- Monitor analytics
- Check Web Vitals

---

## Troubleshooting

### Build Fails on Railway

**Problem:** Build command fails

**Solution:**
1. Check that root directory is set to `apps/api`
2. Verify build command includes workspace installation:
   ```bash
   npm install && cd ../.. && npm run db:generate && cd apps/api && npm run build
   ```

### Database Connection Errors

**Problem:** Cannot connect to database

**Solution:**
1. Verify `DATABASE_URL` is referencing Railway Postgres: `${{Postgres.DATABASE_URL}}`
2. Run migrations: `npx prisma migrate deploy`
3. Check database is running in Railway dashboard

### CORS Errors

**Problem:** Frontend shows CORS errors

**Solution:**
1. Update `ALLOWED_ORIGINS` in Railway to include your Vercel domain
2. Include both production and preview URLs:
   ```
   https://your-app.vercel.app,https://your-app-*.vercel.app
   ```

### Frontend Can't Connect to Backend

**Problem:** API calls fail from frontend

**Solution:**
1. Verify `NEXT_PUBLIC_API_URL` in Vercel points to Railway domain
2. Ensure Railway domain is publicly accessible
3. Check Railway logs for errors

### Prisma Migration Issues

**Problem:** Migrations fail or database is not seeded

**Solution:**
1. Connect to Railway via terminal:
   - Railway dashboard → Service → Terminal
2. Run migrations manually:
   ```bash
   npx prisma migrate deploy
   npx prisma db seed
   ```

### Environment Variables Not Working

**Problem:** Changes to environment variables not reflecting

**Solution:**
1. After updating variables in Railway, trigger a new deployment
2. In Vercel, redeploy from the Deployments page
3. Hard refresh your browser (Ctrl+Shift+R)

---

## Deployment Checklist

### Pre-Deployment
- [ ] Code pushed to GitHub
- [ ] All environment variables documented
- [ ] Database migrations tested locally
- [ ] Build succeeds locally

### Railway (Backend)
- [ ] PostgreSQL database created
- [ ] Redis instance created
- [ ] Backend service configured with correct root directory
- [ ] All environment variables set
- [ ] Database migrations run successfully
- [ ] Database seeded
- [ ] Custom domain configured (optional)
- [ ] Health check endpoint responding

### Vercel (Frontend)
- [ ] Project imported from GitHub
- [ ] Root directory set to `apps/web`
- [ ] Build and install commands configured
- [ ] Environment variables set
- [ ] Production deployment successful
- [ ] Custom domain configured (optional)
- [ ] Can successfully connect to backend API

### Post-Deployment
- [ ] CORS configured correctly
- [ ] Admin login working
- [ ] All critical features tested
- [ ] Monitoring set up
- [ ] Production secrets rotated
- [ ] Team has access to both platforms

---

## Useful Commands

### Trigger Redeployment

**Railway:**
```bash
# Via Railway CLI
railway up
```

**Vercel:**
```bash
# Via Vercel CLI
vercel --prod
```

### View Logs

**Railway:**
```bash
railway logs
```

**Vercel:**
```bash
vercel logs
```

### Database Management

**Connect to Railway Postgres:**
```bash
# Via Railway CLI
railway connect postgres
```

**Run Prisma Commands:**
```bash
# Generate Prisma Client
railway run npx prisma generate

# Run migrations
railway run npx prisma migrate deploy

# Seed database
railway run npx prisma db seed
```

---

## Additional Resources

- [Railway Documentation](https://docs.railway.app)
- [Vercel Documentation](https://vercel.com/docs)
- [Prisma Deployment Guide](https://www.prisma.io/docs/guides/deployment)
- [Next.js Deployment](https://nextjs.org/docs/deployment)
- [NestJS Deployment](https://docs.nestjs.com/deployment)

---

## Support

If you encounter issues:
1. Check Railway logs for backend errors
2. Check Vercel logs for frontend errors
3. Review environment variables
4. Verify database connectivity
5. Check CORS configuration
